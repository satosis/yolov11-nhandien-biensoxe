services:
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./deploy/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./data/mosquitto:/mosquitto/data
      - ./data/mosquitto-log:/mosquitto/log
    networks:
      - surv-net

  frigate:
    image: ghcr.io/blakeblackshear/frigate:stable
    container_name: frigate
    restart: unless-stopped
    privileged: true
    shm_size: "256mb"
    depends_on:
      - mosquitto
    env_file:
      - ./.env
      - ./.camera.env
    ports:
      - "5000:5000"
      - "8554:8554"
      - "8555:8555/tcp"
      - "8555:8555/udp"
    environment:
      - TZ=Asia/Ho_Chi_Minh
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./deploy/frigate/config.yml:/config/config.yml:ro
      - ./data/frigate:/media/frigate
    networks:
      - surv-net

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    depends_on:
      - mosquitto
    env_file:
      - ./.env
      - ./.camera.env
    network_mode: host
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - HA_INTERNAL_URL=${HA_INTERNAL_URL:-http://127.0.0.1:8123}
      - HA_EXTERNAL_URL=${HA_EXTERNAL_URL:-http://127.0.0.1:8123}
    volumes:
      - ./data/homeassistant:/config
      - /etc/localtime:/etc/localtime:ro

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    profiles: ["remote_ha"]
    depends_on:
      - homeassistant
    network_mode: host
    command: tunnel --no-autoupdate run --token ${CLOUDFLARED_TUNNEL_TOKEN}
    environment:
      - TUNNEL_METRICS=127.0.0.1:60123

  event_bridge:
    build: ./deploy/event_bridge
    container_name: event_bridge
    restart: unless-stopped
    depends_on:
      - mosquitto
    env_file:
      - ./.env
      - ./.camera.env
    environment:
      - TZ=Asia/Ho_Chi_Minh
    volumes:
      - ./data/event_bridge:/data
    ports:
      - "8000:8000"
    networks:
      - surv-net

networks:
  surv-net:
    driver: bridge
